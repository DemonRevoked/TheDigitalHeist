#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define XOR_KEY 0x37

static void decode_xor(const unsigned char *src, size_t len, char *dst) {
    for (size_t i = 0; i < len; i++) {
        dst[i] = (char)(src[i] ^ XOR_KEY);
    }
    dst[len] = '\0';
}

// Simple confession app: now lightly obfuscated (XOR-encoded strings) but still entry-level.
int main(void) {
    const unsigned char secret_enc[] = {118,7,104,112,118,99,114,96,118,110,104,116,120,121,113,114,100,100,126,120,121};
    const unsigned char flag_enc[] = {99,115,127,116,99,113,76,118,7,104,112,118,99,114,96,118,110,104,116,120,121,113,114,100,100,126,120,121,104,116,127,7,6,74};
    char secret_phrase[sizeof(secret_enc) + 1];
    char flag[sizeof(flag_enc) + 1];

    decode_xor(secret_enc, sizeof(secret_enc), secret_phrase);
    decode_xor(flag_enc, sizeof(flag_enc), flag);
    
    // Embedded key from build-time (set via -DCHALLENGE_KEY_BUILD during compilation)
    #ifndef CHALLENGE_KEY_BUILD
    #define CHALLENGE_KEY_BUILD "offline-session-key"
    #endif
    const char *embedded_key = CHALLENGE_KEY_BUILD;
    
    // Allow runtime override via environment variable (for container use)
    const char *key = getenv("CHALLENGE_KEY");
    if (!key || strlen(key) == 0) {
        key = embedded_key;  // Use embedded key if no env var
    }
    char input[128];

    printf("=== Confession App v1.0 ===\n");
    printf("Enter confession phrase: ");

    if (!fgets(input, sizeof input, stdin)) {
        fprintf(stderr, "No input received.\n");
        return 1;
    }

    // Strip trailing newline if present.
    input[strcspn(input, "\r\n")] = '\0';

    if (strcmp(input, secret_phrase) == 0) {
        printf("Network Gateway Identified\n");
        printf("Key: %s\n", key);
        printf("Flag: %s\n", flag);
        return 0;
    }

    printf("Invalid phrase. Access denied.\n");
    return 1;
}
