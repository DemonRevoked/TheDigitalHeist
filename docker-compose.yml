services:
  re01-confession-app:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:re-01-v1
    container_name: re01-confession-app
    tty: true          # keep container attached for interactive prompt
    stdin_open: true   # allow input when running `docker compose run`
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=rio
      - STUDENT_PASS=RedCipher@1
    volumes:
      - ./keys/re-01.key:/run/challenge_key:ro
      - ./challenge-files/re-01-confession-app:/challenge-files/re-01-confession-app
    ports:
      - "2222:22"
  re02-evidence-tampering:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:re-02-v1
    container_name: re02-evidence-tampering
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=denver
      - STUDENT_PASS=RedCipher@2
    volumes:
      - ./keys/re-02.key:/run/challenge_key:ro
      - ./challenge-files/re-02-evidence-tampering:/challenge-files/re-02-evidence-tampering
    ports:
      - "2223:22"

  crypto01-intercepted-comms:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:crypto-01-intercepted-comms-v1
    container_name: crypto01-intercepted-comms
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=tokyo
      - STUDENT_PASS=RedCipher@3
    volumes:
      - ./keys/crypto-01.key:/run/challenge_key:ro
      - ./challenge-files/crypto-01-intercepted-comms:/challenge-files/crypto-01-intercepted-comms
    ports:
      - "2224:22"

  crypto02-vault-breach:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:crypto-02-vault-breach-v1
    container_name: crypto02-vault-breach
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=berlin
      - STUDENT_PASS=RedCipher@4
    volumes:
      - ./keys/crypto-02.key:/run/challenge_key:ro
      - ./challenge-files/crypto-02-vault-breach:/challenge-files/crypto-02-vault-breach
    ports:
      - "2225:22"

  crypto03-quantum-safe:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:crypto-03-quantum-safe-v1
    container_name: crypto03-quantum-safe
    restart: "no"
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
    volumes:
      - ./keys/crypto-03.key:/run/challenge_key:ro
      - ./challenge-files/crypto-03-quantum-safe:/challenge-files/crypto-03-quantum-safe

  ai01-artemis:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:ai-01-artemis-v1
    container_name: ai01-artemis
    ports:
      - "8080:8000"
    volumes:
      - ./keys/ai-01.key:/run/secrets/ai-01.key:ro
    restart: unless-stopped

  ai02-cerberus:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:ai-02-cerberus-v1
    container_name: ai02-cerberus
    ports:
      - "8081:5000"
    volumes:
      - ./keys/ai-02.key:/run/secrets/ai-02.key:ro
    environment:
      - FLASK_ENV=production
      - CHALLENGE_KEY_FILE=/run/secrets/ai-02.key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web01-db:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:postgres-16-alpine
    container_name: web01-db
    environment:
      POSTGRES_USER: ctf
      POSTGRES_PASSWORD: royalmint2024
      POSTGRES_DB: ctfdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ctf -d ctfdb"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - web01-pgdata:/var/lib/postgresql/data

  web01-royalmint:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:web-01-royalmint-v1
    container_name: web01-royalmint
    ports:
      - "5001:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://ctf:royalmint2024@web01-db:5432/ctfdb
      - SESSION_SECRET=royalmint_session_secret_key_2024
      - FLAG=TDHCTF{DENVER_LAUGHS_AT_BROKEN_ACL}
      - CHALLENGE_KEY_FILE=/run/secrets/web-01.key
      - RESET_ON_STARTUP=true
    volumes:
      - ./keys/web-01.key:/run/secrets/web-01.key:ro
    depends_on:
      web01-db:
        condition: service_healthy
    restart: unless-stopped

  web02-db:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:postgres-16-alpine
    container_name: web02-db
    environment:
      POSTGRES_USER: ctf
      POSTGRES_PASSWORD: ticketvault2024
      POSTGRES_DB: ctfdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ctf -d ctfdb"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - web02-pgdata:/var/lib/postgresql/data

  web02-ticket-to-the-vault:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:web-02-ticket-to-the-vault-v1
    container_name: web02-ticket-to-the-vault
    ports:
      - "5002:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://ctf:ticketvault2024@web02-db:5432/ctfdb
      - SESSION_SECRET=ticket_vault_session_secret_2024
      - FLAG=TDHCTF{THE_BOT_DID_THE_DIRTY_WORK}
      - RESET_ON_STARTUP=true
      - CHALLENGE_KEY_FILE=/run/secrets/web-02.key
    volumes:
      - ./keys/web-02.key:/run/secrets/web-02.key:ro
    depends_on:
      web02-db:
        condition: service_healthy
    restart: unless-stopped

  web02-admin-bot:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:web-02-admin-bot-v1
    container_name: web02-admin-bot
    environment:
      - BASE_URL=http://web02-ticket-to-the-vault:3000
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-admin123}
      - BOT_INTERVAL_MS=${BOT_INTERVAL_MS:-5000}
    depends_on:
      - web02-ticket-to-the-vault

  web03-safehouse:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:web-03-safehouse-v1
    container_name: web03-safehouse
    ports:
      - "5003:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - SESSION_SECRET=safehouse_session_secret_2024
      - FLAG=TDHCTF{ssrf_internal_pivot}
      - INTERNAL_TOKEN=PROFESSOR_TOKEN_x9f3c2a
      - CHALLENGE_KEY_FILE=/run/secrets/web-03.key
    volumes:
      - ./keys/web-03.key:/run/secrets/web-03.key:ro
    depends_on:
      - web03-internal-admin
    restart: unless-stopped

  web03-internal-admin:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:web-03-internal-admin-v1
    container_name: web03-internal-admin
    networks:
      default:
        aliases:
          - internal-admin
    environment:
      - FLAG=TDHCTF{TOKYO_SENT_THE_TRIGGER}
      - INTERNAL_TOKEN=PROFESSOR_TOKEN_x9f3c2a
      - CHALLENGE_KEY_FILE=/run/secrets/web-03.key
    volumes:
      - ./keys/web-03.key:/run/secrets/web-03.key:ro
    expose:
      - "8080"

  sc01-logview:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:sc-01-logview-v1
    container_name: sc01-logview
    ports:
      - "5101:5101"
    volumes:
      # Challenge KEY is generated by `startup.sh` into ./keys/sc-01.key
      - ./keys/sc-01.key:/run/secrets/sc-01.key:ro
    environment:
      - PORT=5101
      - KEY_FILE=/run/secrets/sc-01.key
      - FLAG=${SC01_FLAG:-TDHCTF{BELLA_CIAO_NO_MORE_DOT_DOT_SLASH}}
    restart: unless-stopped

  sc02-resetpass:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:sc-02-resetpass-v1
    container_name: sc02-resetpass
    ports:
      - "5102:5102"
    volumes:
      # KEY_SECRET is generated by `startup.sh` into ./keys/sc-02.key
      - ./keys/sc-02.key:/run/secrets/sc-02.key:ro
    environment:
      - PORT=5102
      - KEY_SECRET_FILE=/run/secrets/sc-02.key
      - FLAG=${SC02_FLAG:-TDHCTF{ONE_TIME_TOKEN_ONE_TIME_HEIST}}
    restart: unless-stopped

  # ============================================================
  # MOB-02 APK builder (offline artifact)
  # ============================================================
  # Builds the Android APK inside Docker and drops it into ./challenge-files
  # so the landing app can serve it as a downloadable artifact.
  mob02-apkbuilder:
    image: ghcr.io/cirruslabs/android-sdk:35
    container_name: mob02-apkbuilder
    profiles: ["artifacts"]
    working_dir: /work/challenges/mob-02-reset-token-forgery
    volumes:
      - ./:/work:rw
      - mob02-gradle-cache:/root/.gradle
    environment:
      - GRADLE_USER_HOME=/root/.gradle
      # Improve resilience in slower networks (dependency + wrapper downloads).
      - GRADLE_OPTS=-Dorg.gradle.internal.http.connectionTimeout=300000 -Dorg.gradle.internal.http.socketTimeout=300000
    command: bash -lc "chmod +x ./scripts/build_in_container.sh && ./scripts/build_in_container.sh"
    restart: "no"

  # ============================================================
  # MOB-01 APK builder (offline artifact)
  # ============================================================
  mob01-apkbuilder:
    image: ghcr.io/cirruslabs/android-sdk:35
    container_name: mob01-apkbuilder
    profiles: ["artifacts"]
    working_dir: /work/challenges/mob-01-insecure-notes
    volumes:
      - ./:/work:rw
      - mob01-gradle-cache:/root/.gradle
    environment:
      - GRADLE_USER_HOME=/root/.gradle
      - GRADLE_OPTS=-Dorg.gradle.internal.http.connectionTimeout=300000 -Dorg.gradle.internal.http.socketTimeout=300000
    command: bash -lc "chmod +x ./scripts/build_in_container.sh && ./scripts/build_in_container.sh"
    restart: "no"

  exp01-berlinslocker:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:exp-01-berlinslocker-v1
    container_name: exp01-berlinslocker
    ports:
      - "2221:22"
    environment:
      - CTF_KEY=${EXP01_KEY:?EXP01_KEY must be set (generated by startup.sh)}
      - CTF_FLAG=${EXP01_FLAG:-TDHCTF{berlins_locker_compromised}}
    restart: unless-stopped

  exp02-riosradio:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:exp-02-riosradio-v1
    container_name: exp02-riosradio
    ports:
      # Avoid collision with re-01 (2222:22)
      - "2227:22"
    environment:
      - CTF_KEY=${EXP02_KEY:?EXP02_KEY must be set (generated by startup.sh)}
      - CTF_FLAG=${EXP02_FLAG:-TDHCTF{PIVOTED_THEN_ROOTED_BY_CRON}}
    restart: unless-stopped

  landing-app:
    image: asia-south1-docker.pkg.dev/whizhack-vl-438009/docker-images-for-scenarios/thedigitalheist:landing-app-v1
    container_name: landing-app
    ports:
      - "80:80"
    environment:
      - PORT=80
      - CLIENT_ORIGIN=http://localhost
      - CHALLENGE_FILES_DIR=/data/challenge-files
    volumes:
      - ./challenge-files:/data/challenge-files:ro
      # Live-reload source mounts
      - ./webapp/server/src:/app/server/src
      - ./webapp/client/src:/app/client/src
      - ./webapp/client/index.html:/app/client/index.html
      - ./webapp/client/vite.config.js:/app/client/vite.config.js
      - ./webapp/client/public:/app/client/public
    command: >
      sh -c "npm --prefix client run build -- --watch --clearScreen=false &
      PORT=$${PORT:-80} npm --prefix server run dev"

volumes:
  web01-pgdata:
  web02-pgdata:
  mob02-gradle-cache:
  mob01-gradle-cache:
