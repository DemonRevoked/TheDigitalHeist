services:
  re01-confession-app:
    build:
      context: ./challenges/re-01-confession-app
      args:
        CHALLENGE_KEY_BUILD: ${RE01_KEY:-offline-session-key}
    image: digitalheist/re-01
    container_name: re01-confession-app
    tty: true          # keep container attached for interactive prompt
    stdin_open: true   # allow input when running `docker compose run`
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=rio
      - STUDENT_PASS=RedCipher@1
    volumes:
      - ./keys/re-01.key:/run/challenge_key:ro
      - ./challenge-files/re-01-confession-app:/challenge-files/re-01-confession-app
    ports:
      - "2222:22"
  re02-evidence-tampering:
    build:
      context: ./challenges/re-02-evidence-tampering
      args:
        CHALLENGE_KEY_BUILD: ${RE02_KEY:-offline-session-key}
    image: digitalheist/re-02
    container_name: re02-evidence-tampering
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=denver
      - STUDENT_PASS=RedCipher@2
    volumes:
      - ./keys/re-02.key:/run/challenge_key:ro
      - ./challenge-files/re-02-evidence-tampering:/challenge-files/re-02-evidence-tampering
    ports:
      - "2223:22"

  crypto01-intercepted-comms:
    build:
      context: ./challenges/crypto-01-intercepted-comms
    image: digitalheist/crypto-01-intercepted-comms
    container_name: crypto01-intercepted-comms
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=tokyo
      - STUDENT_PASS=RedCipher@3
    volumes:
      - ./keys/crypto-01.key:/run/challenge_key:ro
      - ./challenge-files/crypto-01-intercepted-comms:/challenge-files/crypto-01-intercepted-comms
    ports:
      - "2224:22"

  crypto02-vault-breach:
    build:
      context: ./challenges/crypto-02-vault-breach
    image: digitalheist/crypto-02-vault-breach
    container_name: crypto02-vault-breach
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=berlin
      - STUDENT_PASS=RedCipher@4
    volumes:
      - ./keys/crypto-02.key:/run/challenge_key:ro
      - ./challenge-files/crypto-02-vault-breach:/challenge-files/crypto-02-vault-breach
    ports:
      - "2225:22"

  crypto03-quantum-safe:
    build:
      context: ./challenges/crypto-03-quantum-safe
    image: digitalheist/crypto-03-quantum-safe
    container_name: crypto03-quantum-safe
    restart: "no"
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
    volumes:
      - ./keys/crypto-03.key:/run/challenge_key:ro
      - ./challenge-files/crypto-03-quantum-safe:/challenge-files/crypto-03-quantum-safe

  ai01-artemis:
    build:
      context: ./challenges/ai-01-artemis
      dockerfile: Dockerfile
    image: digitalheist/ai-01-artemis
    container_name: ai01-artemis
    ports:
      - "8080:8000"
    volumes:
      - ./keys/ai-01.key:/run/secrets/ai-01.key:ro
    restart: unless-stopped

  ai02-cerberus:
    build:
      context: ./challenges/ai-02-cerberus
      dockerfile: Dockerfile
    image: digitalheist/ai-02-cerberus
    container_name: ai02-cerberus
    ports:
      - "8081:5000"
    volumes:
      - ./keys/ai-02.key:/run/secrets/ai-02.key:ro
    environment:
      - FLASK_ENV=production
      - CHALLENGE_KEY_FILE=/run/secrets/ai-02.key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web01-db:
    image: postgres:16-alpine
    container_name: web01-db
    environment:
      POSTGRES_USER: ctf
      POSTGRES_PASSWORD: royalmint2024
      POSTGRES_DB: ctfdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ctf -d ctfdb"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - web01-pgdata:/var/lib/postgresql/data

  web01-royalmint:
    build:
      context: ./challenges/web-01-royalmint
    image: digitalheist/web-01-royalmint
    container_name: web01-royalmint
    ports:
      - "5001:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://ctf:royalmint2024@web01-db:5432/ctfdb
      - SESSION_SECRET=royalmint_session_secret_key_2024
      - FLAG=TDHCTF{DENVER_LAUGHS_AT_BROKEN_ACL}
      - CHALLENGE_KEY_FILE=/run/secrets/web-01.key
      - RESET_ON_STARTUP=true
    volumes:
      - ./keys/web-01.key:/run/secrets/web-01.key:ro
    depends_on:
      web01-db:
        condition: service_healthy
    restart: unless-stopped

  web02-db:
    image: postgres:16-alpine
    container_name: web02-db
    environment:
      POSTGRES_USER: ctf
      POSTGRES_PASSWORD: ticketvault2024
      POSTGRES_DB: ctfdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ctf -d ctfdb"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - web02-pgdata:/var/lib/postgresql/data

  web02-ticket-to-the-vault:
    build:
      context: ./challenges/web-02-ticket-to-the-vault
    image: digitalheist/web-02-ticket-to-the-vault
    container_name: web02-ticket-to-the-vault
    ports:
      - "5002:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://ctf:ticketvault2024@web02-db:5432/ctfdb
      - SESSION_SECRET=ticket_vault_session_secret_2024
      - FLAG=TDHCTF{THE_BOT_DID_THE_DIRTY_WORK}
      - RESET_ON_STARTUP=true
      - CHALLENGE_KEY_FILE=/run/secrets/web-02.key
    volumes:
      - ./keys/web-02.key:/run/secrets/web-02.key:ro
    depends_on:
      web02-db:
        condition: service_healthy
    restart: unless-stopped

  web03-safehouse:
    build:
      context: ./challenges/web-03-safehouse
    image: digitalheist/web-03-safehouse
    container_name: web03-safehouse
    ports:
      - "5003:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - SESSION_SECRET=safehouse_session_secret_2024
      - FLAG=TDHCTF{ssrf_internal_pivot}
      - INTERNAL_TOKEN=PROFESSOR_TOKEN_x9f3c2a
      - CHALLENGE_KEY_FILE=/run/secrets/web-03.key
    volumes:
      - ./keys/web-03.key:/run/secrets/web-03.key:ro
    depends_on:
      - web03-internal-admin
    restart: unless-stopped

  web03-internal-admin:
    build:
      context: ./challenges/web-03-safehouse/internal-admin
    image: digitalheist/web-03-internal-admin
    container_name: web03-internal-admin
    networks:
      default:
        aliases:
          - internal-admin
    environment:
      - FLAG=TDHCTF{TOKYO_SENT_THE_TRIGGER}
      - INTERNAL_TOKEN=PROFESSOR_TOKEN_x9f3c2a
      - CHALLENGE_KEY_FILE=/run/secrets/web-03.key
    volumes:
      - ./keys/web-03.key:/run/secrets/web-03.key:ro
    expose:
      - "8080"

  landing-app:
    build:
      context: .
      dockerfile: webapp/Dockerfile
    image: digitalheist/landing-app
    container_name: landing-app
    ports:
      - "80:80"
    environment:
      - PORT=80
      - CLIENT_ORIGIN=http://localhost
      - CHALLENGE_FILES_DIR=/data/challenge-files
    volumes:
      - ./challenge-files:/data/challenge-files:ro
      # Live-reload source mounts
      - ./webapp/server/src:/app/server/src
      - ./webapp/client/src:/app/client/src
      - ./webapp/client/index.html:/app/client/index.html
      - ./webapp/client/vite.config.js:/app/client/vite.config.js
      - ./webapp/client/public:/app/client/public
    command: >
      sh -c "npm --prefix client run build -- --watch --clearScreen=false &
      PORT=$${PORT:-80} npm --prefix server run dev"

volumes:
  web01-pgdata:
  web02-pgdata:
