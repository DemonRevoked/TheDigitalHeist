services:
  re01-confession-app:
    build:
      context: ./challenges/re-01-confession-app
      args:
        CHALLENGE_KEY_BUILD: ${RE01_KEY:-offline-session-key}
    image: digitalheist/re-01
    container_name: re01-confession-app
    tty: true          # keep container attached for interactive prompt
    stdin_open: true   # allow input when running `docker compose run`
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=rio
      - STUDENT_PASS=RedCipher@1
    volumes:
      - ./keys/re-01.key:/run/challenge_key:ro
      - ./challenge-files/re-01-confession-app:/challenge-files/re-01-confession-app
    ports:
      - "2222:22"
  re02-evidence-tampering:
    build:
      context: ./challenges/re-02-evidence-tampering
      args:
        CHALLENGE_KEY_BUILD: ${RE02_KEY:-offline-session-key}
    image: digitalheist/re-02
    container_name: re02-evidence-tampering
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=denver
      - STUDENT_PASS=RedCipher@2
    volumes:
      - ./keys/re-02.key:/run/challenge_key:ro
      - ./challenge-files/re-02-evidence-tampering:/challenge-files/re-02-evidence-tampering
    ports:
      - "2223:22"

  crypto01-intercepted-comms:
    build:
      context: ./challenges/crypto-01-intercepted-comms
    image: digitalheist/crypto-01-intercepted-comms
    container_name: crypto01-intercepted-comms
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=tokyo
      - STUDENT_PASS=RedCipher@3
    volumes:
      - ./keys/crypto-01.key:/run/challenge_key:ro
      - ./challenge-files/crypto-01-intercepted-comms:/challenge-files/crypto-01-intercepted-comms
    ports:
      - "2224:22"

  crypto02-vault-breach:
    build:
      context: ./challenges/crypto-02-vault-breach
    image: digitalheist/crypto-02-vault-breach
    container_name: crypto02-vault-breach
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=berlin
      - STUDENT_PASS=RedCipher@4
    volumes:
      - ./keys/crypto-02.key:/run/challenge_key:ro
      - ./challenge-files/crypto-02-vault-breach:/challenge-files/crypto-02-vault-breach
    ports:
      - "2225:22"

  crypto03-quantum-safe:
    build:
      context: ./challenges/crypto-03-quantum-safe
    image: digitalheist/crypto-03-quantum-safe
    container_name: crypto03-quantum-safe
    tty: true
    stdin_open: true
    environment:
      - CHALLENGE_KEY_FILE=/run/challenge_key
      - STUDENT_USER=nairobi
      - STUDENT_PASS=RedCipher@5
    volumes:
      - ./keys/crypto-03.key:/run/challenge_key:ro
      - ./challenge-files/crypto-03-quantum-safe:/challenge-files/crypto-03-quantum-safe
    ports:
      - "2226:22"

  ai01-artemis:
    build:
      context: ./challenges/ai-01-artemis
      dockerfile: Dockerfile
    image: digitalheist/ai-01-artemis
    container_name: ai01-artemis
    ports:
      - "8080:8000"
    volumes:
      # - ./challenges/ai-01-artemis/incident_package:/challenge/incident_package:ro
      - ./challenges/ai-01-artemis/incident_package.zip:/challenge/incident_package.zip:ro
      - ./challenges/ai-01-artemis/index.html:/challenge/index.html:ro
    restart: unless-stopped

  ai02-cerberus:
    build:
      context: ./challenges/ai-02-cerberus
      dockerfile: Dockerfile
    image: digitalheist/ai-02-cerberus
    container_name: ai02-cerberus
    ports:
      - "8081:5000"
    environment:
      - FLASK_ENV=production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  landing-app:
    build:
      context: .
      dockerfile: webapp/Dockerfile
    image: digitalheist/landing-app
    container_name: landing-app
    ports:
      - "80:80"
    environment:
      - PORT=80
      - CLIENT_ORIGIN=http://localhost
      - CHALLENGE_FILES_DIR=/data/challenge-files
    volumes:
      - ./challenge-files:/data/challenge-files:ro
      # Live-reload source mounts
      - ./webapp/server/src:/app/server/src
      - ./webapp/client/src:/app/client/src
      - ./webapp/client/index.html:/app/client/index.html
      - ./webapp/client/vite.config.js:/app/client/vite.config.js
      - ./webapp/client/public:/app/client/public
    command: >
      sh -c "npm --prefix client run build -- --watch --clearScreen=false &
      PORT=$${PORT:-80} npm --prefix server run dev"
